<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Garden - Monitoring</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #ecfdf5;
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        /* Header styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .title {
            font-size: 32px;
            font-weight: bold;
            color: #065f46;
        }

        .login-btn {
            background-color: #10b981;
            color: white;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Card styles */
        .card {
            background-color: white;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 24px;
            font-weight: bold;
            color: #065f46;
            margin-bottom: 16px;
        }

        .image-container {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }

        .image-box {
            width: 256px;
            height: 256px;
            background-color: #4b5563;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .device-image-box {
            width: 256px;
            height: 256px;
            background-color: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .status-box {
            background-color: #ecfdf5;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-label {
            color: #059669;
            font-size: 18px;
            font-weight: 500;
        }

        .status-value {
            color: #065f46;
            font-size: 36px;
            font-weight: bold;
        }

        /* Status styles */
        .status-value.active {
            color: #059669;
        }

        .status-value.inactive {
            color: #eb6363;
        }

        .icon-circle {
            background-color: #10b981;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .icon-circle.active {
            background-color: #059669;
        }

        .icon-circle.inactive {
            background-color: #10b981;
        }

        .icon {
            width: 32px;
            height: 32px;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .image-box, .device-image-box {
                width: 200px;
                height: 200px;
            }
            
            .icon-circle {
                width: 56px;
                height: 56px;
            }
            
            .icon {
                width: 28px;
                height: 28px;
            }
            
            .status-value {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">My Garden</h1>
            <button class="login-btn">Login</button>
        </header>

        <div class="card">
            <h2 class="card-title">Soil Status</h2>
            
            <div class="image-container">
                <div class="image-box">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/status-bunga-dnd9WGLvKKKJI7AvKzoRb88Si9Co8E.png" alt="Plant">
                </div>
            </div>
            
            <div class="status-box">
                <div>
                    <p class="status-label">Moisture Level</p>
                    <p class="status-value" id="moisture-level">Loading...</p>
                </div>
                <div class="icon-circle">
                    <svg width="18" height="24" viewBox="0 0 18 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 24C4.03125 24 0 19.9688 0 15C0 10.725 6.10313 2.70469 7.80938 0.548437C8.09063 0.196875 8.50781 0 8.95781 0H9.04219C9.49219 0 9.90937 0.196875 10.1906 0.548437C11.8969 2.70469 18 10.725 18 15C18 19.9688 13.9688 24 9 24ZM4.5 15.75C4.5 15.3375 4.1625 15 3.75 15C3.3375 15 3 15.3375 3 15.75C3 18.6516 5.34844 21 8.25 21C8.6625 21 9 20.6625 9 20.25C9 19.8375 8.6625 19.5 8.25 19.5C6.17812 19.5 4.5 17.8219 4.5 15.75Z" fill="black"/>
                        </svg>
                        
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Device Status</h2>
            
            <div class="image-container">
                <div class="device-image-box">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/pompa-Q8gS4H1ptL9ryz5pQ7kuPDbxTx7Std.png" alt="Device">
                </div>
            </div>
            
            <div class="status-box">
                <div>
                    <p class="status-label">Pump Status</p>
                    <p class="status-value" id="pump-status">Loading...</p>
                </div>
                <div class="icon-circle" id="pump-icon">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18.36 6.64C19.6184 7.89879 20.4753 9.50244 20.8223 11.2482C21.1693 12.9939 20.9909 14.8034 20.3096 16.4478C19.6284 18.0921 18.4748 19.4976 16.9948 20.4864C15.5148 21.4752 13.7749 22.0029 11.995 22.0029C10.2151 22.0029 8.47515 21.4752 6.99517 20.4864C5.51519 19.4976 4.36164 18.0921 3.68036 16.4478C2.99909 14.8034 2.82069 12.9939 3.16772 11.2482C3.51475 9.50244 4.37162 7.89879 5.63 6.64" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 2V12" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://mjorypiwtsungpkqgbpv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qb3J5cGl3dHN1bmdwa3FnYnB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIzODU1MzAsImV4cCI6MjA1Nzk2MTUzMH0.hSfqtqBMsRWomc6sIh-b8AUkRPry_ARt7gP4oZrRb9Q';

    // Initialize Supabase client
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Status page functionality
    document.addEventListener('DOMContentLoaded', async function() {
        // Check if user is already logged in
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        if (user) {
            // If logged in, redirect to controller
            window.location.href = 'controller.html';
            return;
        }
        
        // Add event listener to login button
        const loginBtn = document.querySelector('.login-btn');
        if (loginBtn) {
            loginBtn.addEventListener('click', function() {
                window.location.href = 'login.html';
            });
        }
        
        // Specific user ID to fetch data for
        const specificUserId = '418bc539-06ed-4d98-b40a-7a3a41431e4d';
        
        // Set up real-time subscriptions for the specific user
        const sensorSubscription = supabaseClient
            .channel('sensors-changes')
            .on('postgres_changes', 
                { 
                    event: '*', // Listen to all events (INSERT, UPDATE, DELETE)
                    schema: 'public', 
                    table: 'sensors',
                    filter: `user_id=eq.${specificUserId}`
                }, 
                (payload) => {
                    const newData = payload.new;
                    const moistureLevelElement = document.getElementById('moisture-level');
                    if (moistureLevelElement && newData.moisture_level) {
                        moistureLevelElement.textContent = `${newData.moisture_level}%`;
                    }
                }
            )
            .subscribe();
            
        const pumpSubscription = supabaseClient
            .channel('pump-changes')
            .on('postgres_changes', 
                { 
                    event: '*', // Listen to all events (INSERT, UPDATE, DELETE)
                    schema: 'public', 
                    table: 'water_pump',
                    filter: `user_id=eq.${specificUserId}`
                }, 
                (payload) => {
                    const newData = payload.new;
                    const pumpStatusElement = document.getElementById('pump-status');
                    const pumpIcon = document.getElementById('pump-icon');
                    if (pumpStatusElement && newData.pump_status) {
                        pumpStatusElement.textContent = newData.pump_status;
                        pumpStatusElement.className = `status-value ${newData.pump_status.toLowerCase()}`;
                        pumpIcon.className = `icon-circle ${newData.pump_status.toLowerCase()}`;
                    }
                }
            )
            .subscribe();

        // Initial data fetch for sensors
        try {
            const { data: sensorData, error: sensorError } = await supabaseClient
                .from('sensors')
                .select('*')
                .eq('user_id', specificUserId)
                .order('recorded_at', { ascending: false })
                .limit(1)
                .single();
                
            if (!sensorError && sensorData) {
                const moistureLevelElement = document.getElementById('moisture-level');
                if (moistureLevelElement) {
                    moistureLevelElement.textContent = `${sensorData.moisture_level}%`;
                }
            }
        } catch (error) {
            console.error('Error fetching initial sensor data:', error);
        }

        // Initial data fetch for pump status  
        try {
            const { data: pumpData, error: pumpError } = await supabaseClient
                .from('water_pump')
                .select('*')
                .eq('user_id', specificUserId)
                .order('updated_at', { ascending: false })
                .limit(1)
                .single();
                
            if (!pumpError && pumpData) {
                const pumpStatusElement = document.getElementById('pump-status');
                const pumpIcon = document.getElementById('pump-icon');
                if (pumpStatusElement) {
                    pumpStatusElement.textContent = pumpData.pump_status;
                    pumpStatusElement.className = `status-value ${pumpData.pump_status.toLowerCase()}`;
                    pumpIcon.className = `icon-circle ${pumpData.pump_status.toLowerCase()}`;
                }
            }
        } catch (error) {
            console.error('Error fetching initial pump data:', error);
        }
    });
    </script>
</body>
</html>
